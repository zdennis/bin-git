#!/usr/bin/env ruby

VERSION = "1.0.0"
SCRIPT_NAME = File.basename(__FILE__)

if ARGV.include?("-h") || ARGV.include?("--help")
  puts <<~HELP
    #{SCRIPT_NAME} - Show who owns a file according to CODEOWNERS

    Usage: #{SCRIPT_NAME} [options] <file> [file...]

    Options:
      -h, --help     Show this help message
      -v, --version  Show version information

    Arguments:
      file           One or more file paths to check ownership

    Description:
      Uses github-codeowners to show who owns a given file according
      to the CODEOWNERS file in the repository.

    Requirements:
      npm install -g github-codeowners

    Examples:
      #{SCRIPT_NAME} app/models/user.rb
      #{SCRIPT_NAME} app/models/*.rb

    Version: #{VERSION}
  HELP
  exit 0
end

if ARGV.include?("-v") || ARGV.include?("--version")
  puts "#{SCRIPT_NAME} version #{VERSION}"
  exit 0
end

def require_or_install(name, version:, require_as: name)
  require require_as
rescue LoadError => ex
  begin
    puts "Missing gem #{name}. Installing #{name} #{version}..."
    system "gem install #{name} -v #{version}"
    Gem.refresh
    require require_as
  rescue => ex
    puts ex
    puts "#{name} #{version} could not be installed. You will need to install it manually."
    exit 1
  end
end

require_or_install 'term-ansicolor', version: '1.7.1', require_as: 'term/ansicolor'

GITHUB_CODEOWNERS_COMMAND = "github-codeowners"

def command_exists?(command)
  system("command -v #{command} > /dev/null 2>&1")
end

# Filter out flags
args = ARGV.reject { |a| a.start_with?("-") }

if args.empty?
  STDERR.puts "Error: You must provide at least one file path."
  STDERR.puts "Usage: #{SCRIPT_NAME} <file> [file...]"
  exit 1
end

if command_exists?(GITHUB_CODEOWNERS_COMMAND)
  exec "github-codeowners who #{args.join(' ')}"
else
  STDERR.puts Term::ANSIColor.red <<~MESSAGE
    Error: The command "#{GITHUB_CODEOWNERS_COMMAND}" is not installed.

    Please install it via npm:

      npm install -g #{GITHUB_CODEOWNERS_COMMAND}
  MESSAGE
  exit 1
end
