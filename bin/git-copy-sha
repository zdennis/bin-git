#!/usr/bin/env ruby

require 'optparse'

VERSION = "1.0.0"
SCRIPT_NAME = File.basename(__FILE__)

def require_or_install(name, version:, require_as: name)
  require require_as
rescue LoadError
  begin
    puts "Missing gem #{name}. Installing #{name} #{version}..."
    system "gem install #{name} -v #{version}"
    Gem.refresh
    require require_as
  rescue => ex
    puts ex
    puts "#{name} #{version} could not be installed. You will need to install it manually."
    exit 1
  end
end

require_or_install 'term-ansicolor', version: '1.7.1', require_as: 'term/ansicolor'

require 'term/ansicolor'
include Term::ANSIColor

options = {
  numchars: nil,
  short: false
}
opts = OptionParser.new do |opts|
  opts.banner = "Usage: #{SCRIPT_NAME} [options] [sha]"

  opts.on("-n=NUMCHARS", "--num-chars=NUMCHARS", "Number of characters to copy") do |num|
    options[:numchars] = num.to_i
  end

  opts.on("--gcb-short", "Copies the short version of the SHA (7 chars, Google Cloud Build style)") do
    options[:numchars] = 7
  end

  opts.on("-s", "--short-abbrev", "Copy the short-abbreviated form of the current SHA") do
    options[:short] = true
  end

  opts.on("-v", "--version", "Show version information") do
    puts "#{SCRIPT_NAME} version #{VERSION}"
    exit 0
  end

  opts.on("-h", "--help", "Prints help message") do
    puts <<~HELP
      #{SCRIPT_NAME} - Copy commit SHA to clipboard

      #{opts}

      Examples:

        #{bold("# Copies the current commit's SHA")}
        #{SCRIPT_NAME}

        #{bold("# Copies the short abbreviated SHA")}
        #{SCRIPT_NAME} -s

        #{bold("# Copies the SHORT_SHA (7 chars, Google Cloud Build style)")}
        #{SCRIPT_NAME} --gcb-short

        #{bold("# Copies the first 20 characters of the commit SHA")}
        #{SCRIPT_NAME} -n 20

        #{bold("# Copies a specific SHA")}
        #{SCRIPT_NAME} abc1234

      Version: #{VERSION}
    HELP
    exit 0
  end
end.parse!

format = "%H"
format = "%h" if options[:short]

sha = ARGV.shift || `git log -n1 --pretty='#{format}'`.chomp
sha = sha[0...options[:numchars]] if options.fetch(:numchars)
system("echo #{sha} | tr -d '\n' | pbcopy")
