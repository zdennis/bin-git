#!/usr/bin/env ruby

require "optparse"
require 'shellwords'

VERSION = "1.0.0"
SCRIPT_NAME = File.basename(__FILE__)

def require_or_install(name, version:, require_as: name)
  require require_as
rescue LoadError
  begin
    puts "Missing gem #{name}. Installing #{name} #{version}..."
    system "gem install #{name} -v #{version}"
    Gem.refresh
    require require_as
  rescue => ex
    puts ex
    puts "#{name} #{version} could not be installed. You will need to install it manually."
    exit 1
  end
end

require_or_install 'term-ansicolor', version: '1.7.1', require_as: 'term/ansicolor'

options = {
  after: nil,
  before: nil,
  filename_patterns: [],
  oneline: false,
  quiet: false,
  debug: false
}
OptionParser.new do |opts|
  opts.banner = "Usage: #{SCRIPT_NAME} [options]"

  opts.on("--after=DATETIME", "Only show stashes after this date") do |datetime|
    options[:after] = datetime
  end

  opts.on("--before=DATETIME", "Only show stashes before this date") do |datetime|
    options[:before] = datetime
  end

  opts.on("-f", "--filename-pattern=GLOB", "Pattern to match in stashed files") do |glob|
    options[:filename_patterns] << glob
  end

  opts.on("--oneline", "Show oneline format") do
    options[:oneline] = true
  end

  opts.on("-q", "--quiet", "Suppress diff output") do
    options[:quiet] = true
  end

  opts.on("--debug", "Show debug information") do
    options[:debug] = true
  end

  opts.on("-v", "--version", "Show version information") do
    puts "#{SCRIPT_NAME} version #{VERSION}"
    exit 0
  end

  opts.on("-h", "--help", "Show help message") do
    puts <<~HELP
      #{SCRIPT_NAME} - Find stashes containing specific file changes

      #{opts}

      Description:
        Searches through stashes to find ones that contain changes
        to files matching the specified pattern.

      Examples:
        #{Term::ANSIColor.bold("# Find stashes modifying files matching 'config'")}
        #{SCRIPT_NAME} -f config

        #{Term::ANSIColor.bold("# Find stashes from the past week")}
        #{SCRIPT_NAME} -f config --after "1 week ago"

        #{Term::ANSIColor.bold("# Find stashes with oneline output")}
        #{SCRIPT_NAME} -f config --oneline

        #{Term::ANSIColor.bold("# Find stashes without showing diff")}
        #{SCRIPT_NAME} -f config --oneline --quiet

      Version: #{VERSION}
    HELP
    exit 0
  end
end.parse!

after_datetime = options.fetch(:after)
before_datetime = options.fetch(:before)
filename_patterns = options.fetch(:filename_patterns)
oneline = options.fetch(:oneline)
quiet = options.fetch(:quiet)
debug = options.fetch(:debug)

list_command = %|git stash list|
list_command << " --after=#{after_datetime.shellescape}" if after_datetime
list_command << " --before=#{before_datetime.shellescape}" if before_datetime
list_output = `#{list_command}`

stashes = list_output.scan(/^[^:]+/)

stashes.each do |stash|
  show_command = %|git show --name-status #{stash.shellescape} --format=""|
  puts Term::ANSIColor.bold "Running command: #{show_command}" if debug
  files = `#{show_command}`.lines
  found = files.any? do |file|
    filename_patterns.find { |pattern| file.match?(pattern) }
  end

  if found
    if oneline
      command = %|git show --oneline #{stash.shellescape}|
      command << " --quiet" if quiet
      puts Term::ANSIColor.bold "Running command: #{command}" if debug
      system(command)
    else
      puts "#{stash}"
    end
  end
end
