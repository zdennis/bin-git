#!/usr/bin/env ruby

require 'json'

VERSION = "1.0.0"
SCRIPT_NAME = File.basename(__FILE__)

if ARGV.include?("-h") || ARGV.include?("--help")
  puts <<~HELP
    #{SCRIPT_NAME} - Open or create a pull request

    Usage: #{SCRIPT_NAME} [options] [sha-or-ref]

    Options:
      -h, --help     Show this help message
      -v, --version  Show version information

    Arguments:
      sha-or-ref     SHA, branch, or PR number (optional)

    Description:
      Opens an existing pull request or creates a new one:
      - With no arguments: opens existing PR for current branch, or creates new one
      - With PR number: opens that PR
      - With SHA/ref: opens PR containing that commit

    Examples:
      # Open/create PR for current branch
      #{SCRIPT_NAME}

      # Open PR #123
      #{SCRIPT_NAME} 123

      # Open PR containing a specific commit
      #{SCRIPT_NAME} abc1234

    Version: #{VERSION}
  HELP
  exit 0
end

if ARGV.include?("-v") || ARGV.include?("--version")
  puts "#{SCRIPT_NAME} version #{VERSION}"
  exit 0
end

if %x{which gh}.chomp.empty?
  STDERR.puts <<~MESSAGE
    Error: The gh command is not found. Install with:

        brew install gh

    For more options see https://cli.github.com/
  MESSAGE
  exit 1
end

# Filter out any remaining flags
args = ARGV.reject { |a| a.start_with?("-") }
ARGV_PROVIDED_SHA_OR_REF = args.shift
SHA_OR_REF = ARGV_PROVIDED_SHA_OR_REF || %x{git rev-parse HEAD}.chomp

if SHA_OR_REF =~ /^\d+$/
  # when SHA_OR_REF is a PR number itself
  open %x{git pull-url $SHA_OR_REF}
else
  repos = %x{git config remote.origin.url}.scan(/github.com[:\/](.*)/).flatten.first.to_s.sub('.git', '')
  if repos.empty?
    puts "The origin url could not be extracted running %x{git config remote.origin.url}"
    exit 1
  end

  repo_info_json = JSON.parse(%x{gh repo view --json name,nameWithOwner})
  repo_name = repo_info_json.fetch("name")
  repo_name_with_owner = repo_info_json.fetch("nameWithOwner")
  base_branch = %x{git get-main-branch}.chomp

  if ARGV_PROVIDED_SHA_OR_REF
    json_response = %x{gh api repos/#{repo_name_with_owner}/commits/#{SHA_OR_REF}/pulls}
    response_data = JSON.parse(json_response)

    if response_data.is_a?(Hash) && response_data['message'] =~ /no commit found/i
      puts response_data['message']
      exit 1
    end
  else
    org_name = %x{git github-org-name}.chomp
    branch_name = %x{git rev-parse --abbrev-ref HEAD}.chomp
    current_branch = %x{git current-branch}.chomp

    # Check if a PR already exists for the current branch (with any base branch)
    existing_prs_json = %x{gh pr list --head "#{current_branch}" --json number,url,baseRefName}
    existing_prs = JSON.parse(existing_prs_json)

    if !existing_prs.empty?
      pr = existing_prs.first
      puts "Found existing PR ##{pr['number']} (base: #{pr['baseRefName']})"
      puts "Opening: #{pr['url']}"
      system "open", pr['url']
    else
      template = ".github/PULL_REQUEST_TEMPLATE.md"

      command = %|gh pr create --web --base="#{base_branch}" --head="#{current_branch}"|

      # Github broke the client again and template(s) aren't working so pass through --body-file now.
      command << " --body-file #{template}" if File.exist?(template)

      # template option broken? 2025-01-15
      # however, if it is omitted then the template works when opening the PR
      # command << " --template #{File.basename(template)}" if File.exist?(template)
      puts command
      system command
    end
  end
end
