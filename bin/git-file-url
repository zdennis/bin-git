#!/usr/bin/env ruby

require 'optparse'

VERSION = "1.0.0"
SCRIPT_NAME = File.basename(__FILE__)

options = {
  ref: nil,
  line: nil
}

parser = OptionParser.new do |opts|
  opts.banner = "Usage: #{SCRIPT_NAME} [options] FILE [FILE...]"
  opts.separator ""
  opts.separator "Generate GitHub URLs for file(s)"
  opts.separator ""
  opts.separator "Options:"

  opts.on("-r", "--ref REF", "Branch, tag, or commit SHA (defaults to current branch)") do |ref|
    options[:ref] = ref
  end

  opts.on("-l", "--line LINE", "Line number or range (e.g., 42 or 42:50)") do |line|
    options[:line] = line
  end

  opts.on("-v", "--version", "Show version information") do
    puts "#{SCRIPT_NAME} version #{VERSION}"
    exit 0
  end

  opts.on("-h", "--help", "Show this help message") do
    puts <<~HELP
      #{SCRIPT_NAME} - Generate GitHub URLs for file(s)

      #{opts}

      Examples:
        # URL for a single file
        #{SCRIPT_NAME} path/to/file.rb

        # URL for a file on specific branch
        #{SCRIPT_NAME} -r main path/to/file.rb

        # URL for a specific line
        #{SCRIPT_NAME} -l 42 path/to/file.rb

        # URL for a line range
        #{SCRIPT_NAME} -l 42:50 path/to/file.rb

      Version: #{VERSION}
    HELP
    exit 0
  end
end

begin
  parser.parse!
rescue OptionParser::InvalidOption, OptionParser::MissingArgument => e
  puts "Error: #{e.message}"
  puts parser
  exit 1
end

if ARGV.empty?
  puts "Error: At least one FILE path is required"
  puts parser
  exit 1
end

file_paths = ARGV

# Get base URL
base_url = %x{git url}.chomp

if base_url.empty?
  puts "Error: Could not determine repository URL"
  exit 1
end

# Get ref (branch/commit)
ref = options[:ref] || %x{git current-branch}.chomp

if ref.empty?
  puts "Error: Could not determine branch"
  exit 1
end

# Generate URLs for each file
file_paths.each do |file_path|
  url = "#{base_url}/blob/#{ref}/#{file_path}"

  # Add line number(s) if specified
  if options[:line]
    if options[:line] =~ /^(\d+):(\d+)$/
      # Line range
      url << "#L#{$1}-L#{$2}"
    elsif options[:line] =~ /^(\d+)$/
      # Single line
      url << "#L#{$1}"
    else
      puts "Error: Invalid line format. Use a number (e.g., 42) or range (e.g., 42:50)"
      exit 1
    end
  end

  puts url
end
