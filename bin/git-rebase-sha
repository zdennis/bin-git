#!/usr/bin/env bash

VERSION="1.0.0"
SCRIPT_NAME="git-rebase-sha"

show_help() {
  cat << EOF
$SCRIPT_NAME - Interactive rebase starting from a specific commit

Usage: $SCRIPT_NAME [options] <sha>

Options:
  -h, --help     Show this help message
  -v, --version  Show version information

Arguments:
  sha            The commit SHA to start rebasing from (required)

Description:
  Starts an interactive rebase from the specified commit. The rebase todo
  is automatically accepted, allowing you to make changes to commits.

Examples:
  # Rebase from a specific commit
  $SCRIPT_NAME abc1234

  # Combined with fixup
  git fixup abc1234 && $SCRIPT_NAME abc1234

Version: $VERSION
EOF
}

case "$1" in
  -h|--help)
    show_help
    exit 0
    ;;
  -v|--version)
    echo "$SCRIPT_NAME version $VERSION"
    exit 0
    ;;
esac

set -e

if [ $# -eq 0 ]; then
  echo "Error: Must provide a SHA as the argument." >&2
  echo "Usage: $SCRIPT_NAME <sha>" >&2
  exit 1
fi

SHA="$1"

# Verify the SHA exists
if ! git rev-parse --verify "$SHA^{commit}" > /dev/null 2>&1; then
  echo "Error: Invalid commit SHA: $SHA" >&2
  exit 1
fi

tempfile=$(mktemp)
cat << 'SCRIPT' >> "$tempfile"
#!/usr/bin/env ruby
# Auto-accept rebase todo
exit 0
SCRIPT

chmod a+x "$tempfile"
GIT_SEQUENCE_EDITOR="$tempfile" git rebase -i --autosquash "$SHA^"
rm -f "$tempfile"
echo "Done!"
