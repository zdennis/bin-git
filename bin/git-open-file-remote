#!/usr/bin/env ruby

require 'optparse'

VERSION = "1.0.0"
SCRIPT_NAME = File.basename(__FILE__)

def bold(str)
  "\e[1m#{str}\e[0m"
end

def red(str)
  "\e[31m#{str}\e[0m"
end

options = {
  open_on_main_branch: false
}

OptionParser.new do |opts|
  opts.banner = "Usage: #{SCRIPT_NAME} [options] <path/to/file>"

  opts.on("-m", "--main", "Open the file on the main branch instead of current branch") do
    options[:open_on_main_branch] = true
  end

  opts.on("-v", "--version", "Show version information") do
    puts "#{SCRIPT_NAME} version #{VERSION}"
    exit 0
  end

  opts.on("-h", "--help", "Prints help message") do
    puts <<~HELP
      #{SCRIPT_NAME} - Open a file on GitHub in browser

      #{opts}

      Description:
        Opens a file from the repository on GitHub in your default browser.

      Examples:
        # Open file on current branch
        #{SCRIPT_NAME} spec/models/wibble_spec.rb

        # Open file on main branch
        #{SCRIPT_NAME} -m spec/models/wibble_spec.rb

      Version: #{VERSION}
    HELP
    exit 0
  end
end.parse!

path = ARGV.shift

if path.nil?
  STDERR.puts red <<~ERROR
    Must provide a path to open. See #{SCRIPT_NAME} --help for more information.
  ERROR
  exit 1
end

url = `git url`.chomp

ref = if options.fetch(:open_on_main_branch)
  `git get-main-branch`.chomp
else
  `git current-branch`.chomp
end

file2open = "#{url}/blob/#{ref}/#{path}"
puts "Opening #{file2open} in your default browser."
system %|open "#{file2open}"|

