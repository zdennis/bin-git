#!/usr/bin/env bash

VERSION="1.0.0"
SCRIPT_NAME="git-link-usages"

show_help() {
  cat << EOF
$SCRIPT_NAME - Generate markdown links for search results

Usage: $SCRIPT_NAME [options] <pattern>

Options:
  -h, --help     Show this help message
  -v, --version  Show version information

Arguments:
  pattern        The search pattern (required)

Description:
  Searches for a pattern in the codebase and outputs markdown-formatted
  links to GitHub for each match. Useful for documentation.

Examples:
  # Find usages and generate links
  $SCRIPT_NAME "MyClass"

Version: $VERSION
EOF
}

case "$1" in
  -h|--help)
    show_help
    exit 0
    ;;
  -v|--version)
    echo "$SCRIPT_NAME version $VERSION"
    exit 0
    ;;
esac

pattern="$1"

if [ -z "$pattern" ]; then
  echo "Error: You must provide a search pattern." >&2
  echo "Usage: $SCRIPT_NAME <pattern>" >&2
  exit 1
fi

base_url=$(git url 2>/dev/null)
if [ -z "$base_url" ]; then
  echo "Error: Could not determine repository URL" >&2
  exit 1
fi

branch=$(git rev-parse --abbrev-ref HEAD 2>/dev/null)
if [ -z "$branch" ]; then
  echo "Error: Could not determine current branch" >&2
  exit 1
fi

grep -nHR "$pattern" --exclude-dir .git $(git ignore-dirs-for-grep 2>/dev/null) $(git ignore-files-for-grep 2>/dev/null) . 2>/dev/null | \
  cut -d: -f1,2 | \
  sed -e 's/:/#L/' | \
  while read -r match; do
    echo "[$match]($base_url/blob/$branch/$match)"
  done
