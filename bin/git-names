#!/usr/bin/env ruby

require 'optparse'

VERSION = "1.0.0"
SCRIPT_NAME = File.basename(__FILE__)

def require_or_install(name, version:, require_as: name)
  require require_as
rescue LoadError
  begin
    puts "Missing gem #{name}. Installing #{name} #{version}..."
    system "gem install #{name} -v #{version}"
    Gem.refresh
    require require_as
  rescue => ex
    puts ex
    puts "#{name} #{version} could not be installed. You will need to install it manually."
    exit 1
  end
end

require_or_install 'term-ansicolor', version: '1.7.1', require_as: 'term/ansicolor'

require 'term/ansicolor'
include Term::ANSIColor

def main_branch
  @main_branch ||= `git get-main-branch`.chomp
end

OptionParser.new do |opts|
  opts.banner = "Usage: #{SCRIPT_NAME} [options] [ref]"

  opts.on("-v", "--version", "Show version information") do
    puts "#{SCRIPT_NAME} version #{VERSION}"
    exit 0
  end

  opts.on("-h", "--help", "Prints help message") do
    main_branch_name = `git get-main-branch 2>/dev/null`.chomp
    main_branch_name = "main" if main_branch_name.empty?

    puts <<~HELP
      #{SCRIPT_NAME} - Display changed filenames for a range of commits

      #{opts}

      Description:
        Shows filenames that changed between commits with their status
        (Added, Modified, Deleted).

      Examples:
        #{bold("# List files changed between this branch and #{main_branch_name}")}
        #{SCRIPT_NAME}

        #{bold("# List files in the last two commits")}
        #{SCRIPT_NAME} HEAD~2

        #{bold("# List files in a custom commit range")}
        #{SCRIPT_NAME} abc..xyz

      Version: #{VERSION}
    HELP
    exit 0
  end
end.parse!


range = if ARGV.empty?
  "#{main_branch}..HEAD"
else
  argv = ARGV.join(" ")
  argv.match("..") ? argv : "HEAD..#{ARGV.first}"
end

command ="git diff --name-status #{range}"
system(command)
