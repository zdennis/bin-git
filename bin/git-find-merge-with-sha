#!/usr/bin/env bash

VERSION="1.0.0"
SCRIPT_NAME="git-find-merge-with-sha"

show_help() {
  cat << EOF
$SCRIPT_NAME - Find the merge commit that includes a SHA

Usage: $SCRIPT_NAME [options] <sha>

Options:
  -h, --help     Show this help message
  -v, --version  Show version information

Arguments:
  sha            The commit SHA to find the merge for (required)

Description:
  Finds the merge commit on the main branch that introduced the given
  commit. Useful for tracking when a commit was merged into main.

Examples:
  # Find when commit abc1234 was merged
  $SCRIPT_NAME abc1234

Version: $VERSION
EOF
}

case "$1" in
  -h|--help)
    show_help
    exit 0
    ;;
  -v|--version)
    echo "$SCRIPT_NAME version $VERSION"
    exit 0
    ;;
esac

SHA="$1"
if [ -z "$SHA" ]; then
  echo "Error: You must provide a SHA." >&2
  echo "Usage: $SCRIPT_NAME <sha>" >&2
  exit 1
fi

main_branch=$(git get-main-branch 2>/dev/null)
if [ -z "$main_branch" ]; then
  echo "Error: Could not determine main branch" >&2
  exit 1
fi

git rev-list "$SHA..$main_branch" --ancestry-path | grep -f <(git rev-list "$SHA..$main_branch" --first-parent) | tail -1
