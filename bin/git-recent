#!/usr/bin/env ruby

require "optparse"

VERSION = "1.0.0"
SCRIPT_NAME = File.basename(__FILE__)

def require_or_install(name, version:, require_as: name)
  require require_as
rescue LoadError
  begin
    puts "Missing gem #{name}. Installing #{name} #{version}..."
    system "gem install #{name} -v #{version}"
    Gem.refresh
    require require_as
  rescue => ex
    puts ex
    puts "#{name} #{version} could not be installed. You will need to install it manually."
    exit 1
  end
end

require_or_install 'term-ansicolor', version: '1.7.1', require_as: 'term/ansicolor'

options = {
  number: 10,
  verbose: false
}

OptionParser.new do |opts|
  opts.banner = "Usage: #{SCRIPT_NAME} [options] [count]"

  opts.on("--version", "Show version information") do
    puts "#{SCRIPT_NAME} version #{VERSION}"
    exit 0
  end

  opts.on("-h", "--help", "Prints help") do
    puts <<~MESSAGE
      #{SCRIPT_NAME} - List recently worked on branches

      #{opts}

      Description:
        Prints out a list of recent branches sorted by last commit date.

      Arguments:
        count          Number of branches to show (default: #{options.fetch(:number)})

      Examples:
        # Show the ten most recent branches
        #{SCRIPT_NAME}

        # Show the 20 most recent branches
        #{SCRIPT_NAME} 20

      Version: #{VERSION}
    MESSAGE
    exit 0
  end

  opts.on("-v", "--verbose", "Turn on verbose output") do
    options[:verbose] = true
  end
end.parse!

count = ARGV.shift.to_i
count = count > 0 ? count : options.fetch(:number)

verbose = options.fetch(:verbose)

command = %|git for-each-ref --count="#{count}" --sort=-committerdate --format='%(refname:short)' refs/heads/|
puts Term::ANSIColor.bold("Running command: #{command}") if verbose
system command
